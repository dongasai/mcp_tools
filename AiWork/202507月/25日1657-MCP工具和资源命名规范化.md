# MCP工具和资源命名规范化

## 任务描述
重新规范 MCP 工具和资源的命名，让同模块的工具采用统一的前缀，提高代码的可维护性和一致性。

## 开始时间
2025年07月25日 16:57

## 当前状态
- Git状态：master分支，领先origin/master 3个提交
- 有未提交的修改文件

## 工作计划
1. 查看现有的 MCP 工具和资源
2. 分析当前命名模式
3. 设计新的命名规范
4. 重构工具和资源名称
5. 更新相关配置和文档

## 进度记录
- [x] 分析现有MCP工具和资源
- [x] 设计命名规范
- [x] 实施重构
- [x] 测试验证
- [x] 更新文档

## 完成情况

### 1. 创建命名规范文档 ✅
- 创建 `docs/mcp-naming-convention.md`
- 定义模块前缀：task_, db_, question_, agent_, time_
- 制定工具和资源命名格式规则
- 提供重构映射表和实施指南

### 2. 重构Database模块 ✅
**工具重构：**
- execute_sql → db_execute_sql
- list_connections → db_list_connections
- test_connection → db_test_connection

**资源重构：**
- databaseConnection → db_connection (dbconnection://{id} → db://connection/{id})
- databaseConnectionList → db_connection_list (dbconnection://list → db://connections)
- sqlExecutionLog → db_execution_log (sqllog://{agentId} → db://log/{agentId})
- sqlExecutionStats → db_execution_stats (sqllog://stats/{agentId} → db://stats/{agentId})

### 3. 重构Task模块 ✅
**工具重构：**
- create_main_task → task_create_main
- create_sub_task → task_create_sub
- list_tasks → task_list
- get_task → task_get
- complete_task → task_complete
- add_comment → task_add_comment
- get_assigned_tasks → task_get_assigned

### 4. 重构其他模块 ✅
**Question模块：**
- ask_question → question_ask

**Agent模块：**
- myInfo → agent_info (myinfo://get → agent://info)

**Time模块：**
- getTime2 → time_current (time://get2 → time://current)

### 5. 测试验证 ✅
- 执行 `php artisan mcp:discover --force` 更新缓存
- 验证所有11个工具和6个资源正确注册
- 确认新的命名规范生效

## 技术成果

### 命名规范化效果
- **工具总数**: 11个，全部采用模块前缀
- **资源总数**: 6个，全部采用模块前缀和统一URI模式
- **模块覆盖**: Task(7), Database(3), Question(1), Agent(1), Time(1)
- **URI统一**: 采用 {module}://{path} 格式

### 代码质量提升
- 提高了代码的可维护性和一致性
- 便于识别工具和资源的功能归属
- 为后续模块扩展提供了标准模板

## 用户反馈改进

### Time模块优化 ✅
根据用户反馈"Time始于用户模块，输出信息，包含用户时区"，对Time模块进行了重大改进：

**改进内容：**
- 集成用户认证和Agent信息获取
- 获取用户时区设置（从User模型的timezone字段）
- 返回多种时间格式：
  - UTC时间（标准时间）
  - 用户时区时间（根据用户设置）
  - 系统时区时间（服务器时区）
- 包含完整的用户信息：ID、姓名、时区、语言
- 包含Agent信息：ID、标识符、名称
- 添加错误处理机制，确保在无法获取用户信息时仍能返回基本时间

**技术实现：**
- 使用AuthenticationService获取当前Agent
- 通过Agent关联获取User信息
- 使用Carbon库进行时区转换和格式化
- 提供ISO8601标准格式和本地化格式

## 重要修正：MCP资源分类

### 用户反馈："有参数的资源应该是'Resource Templates'"
发现了一个重要的MCP协议规范问题：

**问题**：
- 所有资源都被错误地定义为Resources
- 带参数的资源（如{id}、{agentId}）应该是Resource Templates

**修复**：
- 将带参数的资源改为使用McpResourceTemplate属性
- 遵循RFC 6570 URI模板标准
- 正确区分静态资源和动态资源模板

**最终分类**：
- **Resources (3个)**: time://current, agent://info, db://connections
- **Resource Templates (3个)**: db://connection/{id}, db://log/{agentId}, db://stats/{agentId}

**技术改进**：
- 使用uriTemplate参数替代uri参数
- 添加description参数提供更好的文档
- 符合MCP协议规范

## 备注
重构已完成，新的命名规范已生效。Time模块已根据用户反馈进行优化，现在能够提供基于用户时区的完整时间信息。MCP资源分类已修正为符合协议规范。MCP客户端需要更新以使用新的工具名称。
