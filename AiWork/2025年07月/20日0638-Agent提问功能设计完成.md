# Agent提问功能设计完成

**时间**: 2025年07月20日 星期日 06:38:20 CST  
**任务类型**: 功能设计  
**模块**: Agent模块  
**状态**: ✅ 已完成

## 任务概述

为Agent模块规划和设计"提问功能"，使AI Agent能够在执行任务过程中主动向人类用户提出问题，获取指导、确认或澄清，确保任务执行符合用户期望。

## 完成内容

### 1. 功能需求分析
- **设计目标**: 智能提问机制、高效交互体验、灵活扩展性
- **核心价值**: Agent与人类用户的双向交互，提高任务执行准确性
- **应用场景**: 代码实现确认、技术方案咨询、阶段性成果评估

### 2. 技术方案设计

#### 问题类型简化
根据用户反馈，将原计划的5种问题类型简化为2种逻辑类型：
- **选择类 (CHOICE)**: 需要用户做决策选择的问题
- **反馈类 (FEEDBACK)**: 需要用户提供意见反馈的问题

#### 状态管理优化
将原计划的5种状态简化为3种核心状态：
- **待回答 (PENDING)**: 等待用户回答
- **已回答 (ANSWERED)**: 用户已回答，Agent可继续执行
- **已忽略 (IGNORED)**: 用户忽略或超时，Agent使用默认方案

#### 优先级系统
保留4个优先级便于用户按重要性处理：
- **紧急 (URGENT)**: 阻塞任务进行的问题
- **高 (HIGH)**: 影响任务质量的问题
- **中 (MEDIUM)**: 优化方案的选择
- **低 (LOW)**: 细节优化的建议

### 3. 数据库设计

#### AgentQuestion表结构
```sql
CREATE TABLE agent_questions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    agent_id BIGINT NOT NULL,
    task_id BIGINT NULL,
    project_id BIGINT NULL,
    user_id BIGINT NOT NULL,
    
    -- 问题内容
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    context JSON NULL,
    
    -- 问题分类
    question_type ENUM('CHOICE', 'FEEDBACK') NOT NULL,
    priority ENUM('URGENT', 'HIGH', 'MEDIUM', 'LOW') DEFAULT 'MEDIUM',
    
    -- 状态管理
    status ENUM('PENDING', 'ANSWERED', 'IGNORED') DEFAULT 'PENDING',
    
    -- 回答相关
    answer TEXT NULL,
    answer_type ENUM('TEXT', 'CHOICE', 'JSON', 'FILE') NULL,
    answer_options JSON NULL,
    answered_at TIMESTAMP NULL,
    answered_by BIGINT NULL,
    
    -- 时间管理
    expires_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- 外键约束和索引
    FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (answered_by) REFERENCES users(id) ON DELETE SET NULL
);
```

### 4. MCP协议集成

#### Resource URI支持
- `agent://{agent_id}/questions` - 获取Agent的所有问题
- `agent://{agent_id}/questions/pending` - 获取待回答问题
- `task://{task_id}/questions` - 获取任务相关问题
- `project://{project_id}/questions` - 获取项目相关问题

#### Tool Actions设计
- **ask_question**: Agent向用户提出问题
- **get_questions**: 获取问题列表
- **check_answer**: 检查问题是否已被回答

### 5. 服务架构设计

#### 核心服务
- **QuestionService**: 问题管理服务
- **QuestionNotificationService**: 通知服务
- **QuestionTemplateService**: 模板服务
- **QuestionAnalyticsService**: 分析服务

### 6. 实现计划

#### 4个阶段实现计划
- **Phase 1 - 基础功能** (1周): 模型、服务、MCP Tool Actions、API接口
- **Phase 2 - 核心功能** (1周): 通知系统、过期处理、优先级排序
- **Phase 3 - 高级功能** (1周): 智能生成、模板支持、批量处理
- **Phase 4 - 优化集成** (1周): 用户界面、性能优化、测试完善

## 文档更新

### 1. 创建设计文档
- 文件路径: `laravel/app/Modules/Agent/docs/Agent提问功能设计.md`
- 内容: 完整的功能设计、技术方案、实现计划

### 2. 更新Agent模块主文档
- 文件路径: `laravel/app/Modules/Agent/Agent代理模块.md`
- 更新内容:
  - 职责范围新增"Agent交互功能"
  - 模块负责新增"Agent向人类用户的提问功能"
  - 目录结构新增AgentQuestion模型和相关服务
  - 事件系统新增问题相关事件

### 3. 更新开发进度文档
- 文件路径: `laravel/app/Modules/Agent/docs/dev.md`
- 更新内容:
  - 重构文档结构，明确当前开发重点
  - 详细的Agent提问功能实现计划
  - 4个阶段的具体任务清单和验收标准

### 4. 更新项目工作状态
- 文件路径: `AiWork/now.md`
- 更新内容:
  - 新增"阶段9: Agent提问功能设计"已完成
  - 调整当前任务列表，Agent提问功能实现为高优先级
  - 更新项目总体完成度为87%

## 技术要点

### 1. 设计原则
- **简化优先**: 根据用户反馈简化问题类型和状态管理
- **逻辑清晰**: 问题类型基于业务逻辑而非表达方式
- **扩展性强**: 支持未来功能扩展和定制

### 2. 用户体验
- **优先级驱动**: 用户可按优先级顺序处理问题
- **状态明确**: 3种状态覆盖所有业务场景
- **超时处理**: 问题超时自动标记为忽略，Agent可继续执行

### 3. 系统集成
- **MCP协议**: 深度集成MCP协议，支持标准化交互
- **模块化**: 与现有Agent、Task、Project模块无缝集成
- **通知系统**: 实时通知机制确保及时响应

## 下一步计划

### 立即开始 (本周)
1. **Phase 1实现**: 创建AgentQuestion模型和基础服务
2. **MCP集成**: 实现ask_question等Tool Actions
3. **API开发**: 创建基础的问题管理API接口

### 近期目标 (2周内)
1. **Phase 2实现**: 通知系统和过期处理机制
2. **用户界面**: 开发用户后台的问题管理界面
3. **测试验证**: 完整的功能测试和集成测试

## 技术收获

### 1. 需求优化
- 学会根据用户反馈简化复杂设计
- 理解业务逻辑与表达方式的区别
- 掌握状态管理的最小化原则

### 2. 架构设计
- 深入理解MCP协议的扩展机制
- 掌握模块间协作的设计模式
- 学会分阶段实现复杂功能

### 3. 文档管理
- 建立完整的文档更新流程
- 保持文档与代码的同步性
- 创建清晰的开发进度跟踪

## 总结

Agent提问功能设计的完成标志着MCP Tools系统在AI Agent与人类用户交互方面的重要突破。通过简化设计、优化用户体验和深度集成MCP协议，为系统增加了智能提问能力，将显著提高Agent执行任务的准确性和用户满意度。

下一阶段将进入具体实现阶段，预计4周内完成全部功能开发和测试验证。
