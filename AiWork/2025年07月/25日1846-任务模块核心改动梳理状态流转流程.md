# 任务模块核心改动梳理状态流转流程

## 任务概述
- 时间：2025年07月25日 18:46
- 任务：梳理任务模块核心改动，明确主任务和Agent任务分离设计及状态流转流程
- 目标文件：`app/Modules/Task/任务流转流程.md`

## 核心改动要求
1. 任务分为主任务和Agent任务两种类型
2. 明确分两个表记录
3. Agent只能创建Agent任务，可关联主任务
4. 梳理完整的状态流转流程

## 工作状态
- [x] 分析现有任务模块结构
- [x] 设计主任务和Agent任务分离方案
- [x] 梳理状态流转流程
- [x] 更新任务流转流程文档
- [x] 完成工作记录

## 完成内容

### 1. 核心改动设计
- **表结构分离**: 明确分为 `tasks` (主任务) 和 `agent_tasks` (Agent任务) 两个表
- **权限控制**: 用户只能操作主任务，Agent只能操作Agent任务
- **关联关系**: Agent任务可选择性关联主任务，支持独立存在

### 2. 状态流转流程
- **主任务状态**: pending → in_progress ↔ blocked → completed (可取消和重新激活)
- **Agent任务状态**: pending → running ↔ retrying → completed/failed (支持自动重试)
- **完成条件**: 主任务需等待所有关联Agent任务完成

### 3. 业务流程设计
- 典型工作流程：用户创建主任务 → Agent分解为Agent任务 → 执行 → 同步进度 → 完成
- 异常处理：失败重试、任务阻塞、取消机制、孤立任务处理

### 4. 技术实现方案
- 状态机实现类
- MCP协议工具函数设计
- 权限控制矩阵
- 数据模型设计

### 5. 实施计划
分为四个阶段：数据模型分离 → 业务逻辑重构 → MCP协议适配 → 前端界面调整

## 输出文件
- 更新了 `app/Modules/Task/任务流转流程.md` 文档
- 内容简洁明了，专注于核心状态流转流程
- 包含表结构分离、权限分离、状态定义、流转规则、流程图、泳道图和完成条件

## 最终文档内容
文档包含以下核心内容：
1. **核心改动**: 表结构分离和权限分离
2. **主任务状态流转**: 5个状态及其流转规则
3. **Agent任务状态流转**: 6个状态及其流转规则
4. **流程图**: 主任务和Agent任务的简化流程图
5. **泳道图**: 用户、系统、Agent三个泳道的协作流程
6. **完成条件**: 明确的任务完成判断标准

文档去除了冗余内容，专注于状态流转的核心逻辑，便于理解和实施。

## 备注
需要确保Agent权限控制和任务关联关系的合理性。
