# 任务流转流程

## 概述

任务状态机系统提供简化的任务状态转换管理功能，支持基本的业务逻辑验证和自动化流程。

## 核心组件

### TaskStateMachine 状态机类
- **位置**: `app/Modules/Task/Workflows/TaskStateMachine.php`
- **功能**: 管理任务状态转换的核心逻辑
- **特性**:
  - 基础状态转换验证
  - 子任务完成检查
  - 父任务状态约束
  - 错误处理和回滚

### TaskWorkflowService 工作流服务
- **位置**: `app/Modules/Task/Services/TaskWorkflowService.php`
- **功能**: 提供高级工作流管理接口
- **特性**:
  - 状态机实例管理
  - 批量状态转换
  - 自动化流程
  - 健康检查

## 状态转换规则

### 基础状态流转
```
PENDING (待处理)
├── → IN_PROGRESS (进行中)
├── → BLOCKED (已阻塞)
├── → CANCELLED (已取消)
└── → ON_HOLD (暂停)

IN_PROGRESS (进行中)
├── → COMPLETED (已完成)
├── → BLOCKED (已阻塞)
├── → CANCELLED (已取消)
└── → ON_HOLD (暂停)

BLOCKED (已阻塞)
├── → PENDING (待处理)
├── → IN_PROGRESS (进行中)
├── → CANCELLED (已取消)
└── → ON_HOLD (暂停)

ON_HOLD (暂停)
├── → PENDING (待处理)
├── → IN_PROGRESS (进行中)
└── → CANCELLED (已取消)

COMPLETED (已完成) - 终止状态
CANCELLED (已取消) - 终止状态
```

### 业务规则

1. **基础转换验证**: 基于TASKSTATUS枚举的canTransitionTo方法
2. **子任务完成规则**: 主任务只有在所有子任务完成后才能完成
3. **父任务状态约束**: 子任务的状态转换必须符合父任务的状态约束

## 自动化功能

### 1. 自动完成父任务
- **触发条件**: 子任务完成时
- **执行逻辑**: 检查所有子任务是否完成，自动完成父任务
- **配置**: `task.automation.auto_complete_parent_task`

### 2. 自动开始子任务
- **触发条件**: 父任务开始时
- **执行逻辑**: 自动将待处理的子任务转为进行中
- **配置**: `task.automation.auto_start_sub_tasks`

### 3. 定时自动流转
- **命令**: `task:auto-flow`
- **调度**: 每小时执行一次
- **功能**:
  - 超时任务自动阻塞（默认72小时）
  - 父任务自动完成检查
  - 子任务自动开始处理

### 4. 工作流健康检查
- **命令**: `task:workflow-schedule`
- **调度**: 每6小时健康检查，每天凌晨2点完整检查
- **功能**:
  - 检查任务状态一致性
  - 发现工作流问题
  - 发送提醒通知

## 集成方式

### TaskService 集成
TaskService已完全集成工作流服务：
- `startTask()`: 使用状态机执行开始操作
- `completeTask()`: 使用状态机执行完成操作
- `transitionTo()`: 通用状态转换方法
- `canTransition()`: 状态转换验证
- `getAvailableTransitions()`: 获取可用转换

## 测试接口

### 工作流测试控制器
- **位置**: `app/Modules/Task/Controllers/TaskWorkflowTestController.php`
- **路由前缀**: `/api/task-workflow-test`

#### 可用测试端点:
1. `GET /state-machine?task_id={id}` - 测试状态机基础功能
2. `POST /transition` - 测试状态转换
3. `GET /sub-task-completion?parent_task_id={id}` - 测试子任务完成规则
4. `POST /auto-complete-parent` - 测试自动完成父任务
5. `GET /status-options` - 获取状态选项
6. `POST /batch-test` - 批量状态转换测试

## 配置选项

### task.php 配置文件
```php
'automation' => [
    'auto_complete_parent_task' => true,  // 自动完成父任务
    'auto_start_sub_tasks' => false,      // 自动开始子任务

    // 自动流转配置
    'timeout_hours' => 72,                // 任务超时小时数
    'reminder_days' => 7,                 // 提醒天数
    'enable_auto_flow' => true,           // 启用自动流转
],
```

## 定时任务调度

### Laravel 调度配置
```php
// 每小时执行任务自动流转
Schedule::command('task:auto-flow')->hourly();

// 每天凌晨2点执行完整工作流检查
Schedule::command('task:workflow-schedule --type=all')->dailyAt('02:00');

// 每6小时执行工作流健康检查
Schedule::command('task:workflow-schedule --type=health')->everySixHours();
```

### 手动执行命令
```bash
# 执行自动流转（模拟运行）
php artisan task:auto-flow --dry-run

# 执行自动流转（实际执行）
php artisan task:auto-flow

# 执行工作流健康检查
php artisan task:workflow-schedule --type=health --dry-run

# 查看调度列表
php artisan schedule:list
```
