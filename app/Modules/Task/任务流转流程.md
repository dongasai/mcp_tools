# 任务流转流程

## 概述

任务工作流状态机已完成实现，提供了完整的任务状态转换管理功能。系统基于状态机模式设计，支持复杂的业务规则和自动化流程。

## 核心组件

### 1. TaskStateMachine 状态机类
- **位置**: `app/Modules/Task/Workflows/TaskStateMachine.php`
- **功能**: 管理任务状态转换的核心逻辑
- **特性**:
  - 状态转换验证
  - 工作流规则应用
  - 错误处理和回滚
  - 上下文管理

### 2. 工作流规则系统
- **接口**: `WorkflowRuleInterface`
- **抽象基类**: `AbstractWorkflowRule`
- **内置规则**:
  - `BasicTransitionRule`: 基础状态转换验证
  - `SubTaskCompletionRule`: 子任务完成规则
  - `ParentTaskStatusRule`: 父任务状态约束规则

### 3. TaskWorkflowService 工作流服务
- **位置**: `app/Modules/Task/Services/TaskWorkflowService.php`
- **功能**: 提供高级工作流管理接口
- **特性**:
  - 状态机实例管理
  - 批量状态转换
  - 自动化流程
  - 健康检查

## 状态转换规则

### 基础状态流转
```
PENDING (待处理)
├── → IN_PROGRESS (进行中)
├── → BLOCKED (已阻塞)
├── → CANCELLED (已取消)
└── → ON_HOLD (暂停)

IN_PROGRESS (进行中)
├── → COMPLETED (已完成)
├── → BLOCKED (已阻塞)
├── → CANCELLED (已取消)
└── → ON_HOLD (暂停)

BLOCKED (已阻塞)
├── → PENDING (待处理)
├── → IN_PROGRESS (进行中)
├── → CANCELLED (已取消)
└── → ON_HOLD (暂停)

ON_HOLD (暂停)
├── → PENDING (待处理)
├── → IN_PROGRESS (进行中)
└── → CANCELLED (已取消)

COMPLETED (已完成) - 终止状态
CANCELLED (已取消) - 终止状态
```

### 业务规则

#### 1. 子任务完成规则 (SubTaskCompletionRule)
- **适用场景**: 主任务转换为完成状态
- **验证逻辑**: 确保所有子任务都已完成或取消
- **优先级**: 10 (高)

#### 2. 父任务状态规则 (ParentTaskStatusRule)
- **适用场景**: 子任务状态转换
- **验证逻辑**:
  - 父任务完成/取消时，子任务不能开始
  - 父任务阻塞/暂停时，子任务不能开始
- **优先级**: 20 (高)

#### 3. 基础转换规则 (BasicTransitionRule)
- **适用场景**: 所有状态转换
- **验证逻辑**: 基于枚举的canTransitionTo方法
- **优先级**: 1 (最高)

## 自动化功能

### 1. 自动完成父任务
- **触发条件**: 子任务完成时
- **执行逻辑**: 检查所有子任务是否完成，自动完成父任务
- **配置**: `task.automation.auto_complete_parent_task`

### 2. 自动开始子任务
- **触发条件**: 父任务开始时
- **执行逻辑**: 自动将待处理的子任务转为进行中
- **配置**: `task.automation.auto_start_sub_tasks`

### 3. 定时自动流转
- **命令**: `task:auto-flow`
- **调度**: 每小时执行一次
- **功能**:
  - 超时任务自动阻塞（默认72小时）
  - 父任务自动完成检查
  - 子任务自动开始处理
- **配置**: `task.automation.enable_auto_flow`

### 4. 工作流健康检查
- **命令**: `task:workflow-schedule`
- **调度**:
  - 每6小时健康检查
  - 每天凌晨2点完整检查
- **功能**:
  - 检查任务状态一致性
  - 发现工作流问题
  - 发送提醒通知
- **配置**: `task.automation.enable_auto_flow`

## 集成方式

### 1. TaskService 集成
TaskService已完全集成工作流服务：
- `startTask()`: 使用状态机执行开始操作
- `completeTask()`: 使用状态机执行完成操作
- `transitionTo()`: 通用状态转换方法
- `canTransition()`: 状态转换验证
- `getAvailableTransitions()`: 获取可用转换

### 2. 事件系统集成
状态机与现有事件系统无缝集成：
- 状态转换前后触发相应事件
- 保持与现有监听器的兼容性
- 支持自定义事件处理

## 测试接口

### 工作流测试控制器
- **位置**: `app/Modules/Task/Controllers/TaskWorkflowTestController.php`
- **路由前缀**: `/api/task-workflow-test`

#### 可用测试端点:
1. `GET /state-machine?task_id={id}` - 测试状态机基础功能
2. `POST /transition` - 测试状态转换
3. `GET /sub-task-completion?parent_task_id={id}` - 测试子任务完成规则
4. `POST /auto-complete-parent` - 测试自动完成父任务
5. `GET /status-options` - 获取状态选项
6. `POST /batch-test` - 批量状态转换测试

## 配置选项

### task.php 配置文件
```php
'automation' => [
    'auto_complete_parent_task' => true,  // 自动完成父任务
    'auto_start_sub_tasks' => false,      // 自动开始子任务

    // 自动流转配置
    'timeout_hours' => 72,                // 任务超时小时数
    'reminder_days' => 7,                 // 提醒天数
    'enable_auto_flow' => true,           // 启用自动流转
],

'notifications' => [
    'status_changed' => true,             // 状态变更通知
    'progress_updated' => false,          // 进度更新通知
],
```

## 定时任务调度

### Laravel 调度配置
系统已配置以下定时任务：

```php
// 每小时执行任务自动流转
Schedule::command('task:auto-flow')
    ->hourly()
    ->withoutOverlapping()
    ->when(function () {
        return config('task.automation.enable_auto_flow', true);
    });

// 每天凌晨2点执行完整工作流检查
Schedule::command('task:workflow-schedule --type=all')
    ->dailyAt('02:00')
    ->withoutOverlapping();

// 每6小时执行工作流健康检查
Schedule::command('task:workflow-schedule --type=health')
    ->everySixHours()
    ->withoutOverlapping();
```

### 手动执行命令
```bash
# 执行自动流转（模拟运行）
php artisan task:auto-flow --dry-run

# 执行自动流转（实际执行）
php artisan task:auto-flow

# 执行工作流健康检查
php artisan task:workflow-schedule --type=health --dry-run

# 执行完整的工作流调度
php artisan task:workflow-schedule --type=all

# 查看调度列表
php artisan schedule:list
```

## 扩展性

### 添加自定义规则
```php
// 创建自定义规则类
class CustomRule extends AbstractWorkflowRule {
    // 实现规则逻辑
}

// 在服务中使用
$stateMachine = $workflowService->createStateMachine($task);
$stateMachine->addRule(new CustomRule());
```

### 自定义状态机
```php
// 创建带自定义规则的状态机
$stateMachine = $workflowService->addCustomRule($task, new CustomRule());
```

## 监控和诊断

### 工作流健康检查
```php
$health = $workflowService->checkWorkflowHealth($task);
// 返回健康状态、问题和建议
```

### 日志记录
- 所有状态转换都有详细日志
- 规则执行过程记录
- 错误和异常追踪

## 性能考虑

1. **规则优先级**: 按优先级排序执行，避免不必要的验证
2. **缓存机制**: 状态机实例可复用
3. **批量操作**: 支持批量状态转换
4. **事务安全**: 状态转换支持回滚机制

## 总结

任务工作流状态机系统已完全实现，提供了：
- ✅ 完整的状态转换管理
- ✅ 灵活的规则系统
- ✅ 自动化流程支持
- ✅ 完善的测试接口
- ✅ 良好的扩展性
- ✅ 详细的监控和日志

系统从40%完成度提升到100%，满足了所有工作流管理需求。