# Agent ä»£ç†æ¨¡å—

## æ¦‚è¿°

Agentä»£ç†æ¨¡å—è´Ÿè´£ç®¡ç†AI Agentçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬æ³¨å†Œã€è®¤è¯ã€æƒé™æ§åˆ¶ã€çŠ¶æ€ç®¡ç†ç­‰ã€‚è¯¥æ¨¡å—æ˜¯MCP Toolsç³»ç»Ÿä¸­Agentç®¡ç†çš„æ ¸å¿ƒï¼Œç¡®ä¿æ¯ä¸ªAgentéƒ½æœ‰æ˜ç¡®çš„èº«ä»½æ ‡è¯†å’Œè®¿é—®æƒé™ã€‚Agentæ¨¡å—ä¸Useræ¨¡å—åä½œï¼Œä½†ä¸“æ³¨äºAI Agentçš„ç®¡ç†ï¼Œä¸ç›´æ¥å¤„ç†äººç±»ç”¨æˆ·çš„ç®¡ç†ã€‚

## èŒè´£èŒƒå›´

### 1. Agentç”Ÿå‘½å‘¨æœŸç®¡ç†
- Agentæ³¨å†Œå’Œæ³¨é”€
- AgentçŠ¶æ€ç›‘æ§
- Agenté…ç½®ç®¡ç†
- Agentæ€§èƒ½ç»Ÿè®¡

### 2. èº«ä»½è®¤è¯ä¸æˆæƒ
- è®¿é—®ä»¤ç‰Œç®¡ç†
- æƒé™éªŒè¯æœºåˆ¶
- è§’è‰²æƒé™æ§åˆ¶
- å®‰å…¨å®¡è®¡æ—¥å¿—

### 3. é¡¹ç›®è®¿é—®æ§åˆ¶
- é¡¹ç›®çº§æƒé™ç®¡ç†
- èµ„æºè®¿é—®æ§åˆ¶
- æ“ä½œæƒé™éªŒè¯
- åŠ¨æ€æƒé™è°ƒæ•´

### 4. Agentåä½œç®¡ç†
- å¤šAgentåè°ƒ
- ä»»åŠ¡åˆ†é…ç­–ç•¥
- å†²çªæ£€æµ‹å’Œè§£å†³
- è´Ÿè½½å‡è¡¡

## èŒè´£è¾¹ç•Œ

### âœ… Agentæ¨¡å—è´Ÿè´£
- AI Agentçš„æ³¨å†Œã€è®¤è¯å’Œç®¡ç†
- Agentè®¿é—®ä»¤ç‰Œçš„ç”Ÿæˆå’ŒéªŒè¯
- Agentå¯¹é¡¹ç›®å’Œèµ„æºçš„æƒé™æ§åˆ¶
- Agentä¼šè¯ç®¡ç†å’ŒçŠ¶æ€è·Ÿè¸ª
- Agentä¹‹é—´çš„åä½œå’Œå†²çªè§£å†³
- ä¸ºMCPåè®®æä¾›Agentèº«ä»½éªŒè¯

### âŒ Agentæ¨¡å—ä¸è´Ÿè´£
- äººç±»ç”¨æˆ·çš„è´¦æˆ·ç®¡ç†ï¼ˆç”±Useræ¨¡å—å¤„ç†ï¼‰
- äººç±»ç”¨æˆ·çš„ç™»å½•è®¤è¯ï¼ˆç”±Useræ¨¡å—å¤„ç†ï¼‰
- MCPåè®®çš„å…·ä½“å®ç°ï¼ˆç”±MCPæ¨¡å—å¤„ç†ï¼‰
- å…·ä½“çš„ä¸šåŠ¡é€»è¾‘æ‰§è¡Œï¼ˆå§”æ‰˜ç»™ä¸šåŠ¡æ¨¡å—ï¼‰

### ğŸ”„ ä¸å…¶ä»–æ¨¡å—çš„åä½œ
- **Useræ¨¡å—**ï¼šè·å–Agentæ‰€å±ç”¨æˆ·çš„ä¿¡æ¯å’Œæƒé™
- **MCPæ¨¡å—**ï¼šä¸ºMCPè¿æ¥æä¾›Agentè®¤è¯æœåŠ¡
- **Projectæ¨¡å—**ï¼šéªŒè¯Agentå¯¹é¡¹ç›®çš„è®¿é—®æƒé™
- **Taskæ¨¡å—**ï¼šéªŒè¯Agentå¯¹ä»»åŠ¡çš„æ“ä½œæƒé™

## ç›®å½•ç»“æ„

```
app/Modules/Agent/
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Agent.php                  # Agentæ¨¡å‹
â”‚   â”œâ”€â”€ AgentPermission.php        # Agentæƒé™æ¨¡å‹
â”‚   â”œâ”€â”€ AgentSession.php           # Agentä¼šè¯æ¨¡å‹
â”‚   â””â”€â”€ AgentAuditLog.php          # Agentå®¡è®¡æ—¥å¿—æ¨¡å‹
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ AgentService.php           # Agentæ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ AuthenticationService.php  # è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ AuthorizationService.php   # æˆæƒæœåŠ¡
â”‚   â”œâ”€â”€ PermissionService.php      # æƒé™ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ SessionService.php         # ä¼šè¯ç®¡ç†æœåŠ¡
â”œâ”€â”€ Commands/
â”‚   â”œâ”€â”€ RegisterAgentCommand.php   # æ³¨å†ŒAgentå‘½ä»¤
â”‚   â”œâ”€â”€ ListAgentsCommand.php      # åˆ—å‡ºAgentå‘½ä»¤
â”‚   â”œâ”€â”€ RevokeAgentCommand.php     # æ’¤é”€Agentå‘½ä»¤
â”‚   â””â”€â”€ GrantPermissionCommand.php # æˆæƒå‘½ä»¤
â”œâ”€â”€ Policies/
â”‚   â”œâ”€â”€ AgentPolicy.php            # Agentè®¿é—®ç­–ç•¥
â”‚   â”œâ”€â”€ ProjectAccessPolicy.php    # é¡¹ç›®è®¿é—®ç­–ç•¥
â”‚   â””â”€â”€ ResourceAccessPolicy.php   # èµ„æºè®¿é—®ç­–ç•¥
â”œâ”€â”€ Events/
â”‚   â”œâ”€â”€ AgentRegistered.php        # Agentæ³¨å†Œäº‹ä»¶
â”‚   â”œâ”€â”€ AgentAuthenticated.php     # Agentè®¤è¯äº‹ä»¶
â”‚   â”œâ”€â”€ PermissionGranted.php      # æƒé™æˆäºˆäº‹ä»¶
â”‚   â”œâ”€â”€ PermissionRevoked.php      # æƒé™æ’¤é”€äº‹ä»¶
â”‚   â””â”€â”€ AgentSessionExpired.php    # ä¼šè¯è¿‡æœŸäº‹ä»¶
â”œâ”€â”€ Listeners/
â”‚   â”œâ”€â”€ LogAgentActivity.php       # è®°å½•Agentæ´»åŠ¨
â”‚   â”œâ”€â”€ UpdateAgentStatus.php      # æ›´æ–°AgentçŠ¶æ€
â”‚   â””â”€â”€ NotifyPermissionChange.php # é€šçŸ¥æƒé™å˜æ›´
â”œâ”€â”€ Middleware/
â”‚   â”œâ”€â”€ AgentAuthMiddleware.php    # Agentè®¤è¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ PermissionMiddleware.php   # æƒé™æ£€æŸ¥ä¸­é—´ä»¶
â”‚   â””â”€â”€ SessionMiddleware.php      # ä¼šè¯ç®¡ç†ä¸­é—´ä»¶
â”œâ”€â”€ Contracts/
â”‚   â”œâ”€â”€ AgentServiceInterface.php  # AgentæœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ AuthServiceInterface.php   # è®¤è¯æœåŠ¡æ¥å£
â”‚   â””â”€â”€ PermissionInterface.php    # æƒé™æ¥å£
â””â”€â”€ Exceptions/
    â”œâ”€â”€ AgentNotFoundException.php  # Agentæœªæ‰¾åˆ°å¼‚å¸¸
    â”œâ”€â”€ AuthenticationException.php # è®¤è¯å¼‚å¸¸
    â”œâ”€â”€ AuthorizationException.php  # æˆæƒå¼‚å¸¸
    â””â”€â”€ PermissionDeniedException.php # æƒé™æ‹’ç»å¼‚å¸¸
```

## æ ¸å¿ƒæœåŠ¡

### 1. AgentService

```php
<?php

namespace App\Modules\Agent\Services;

use App\Modules\Agent\Contracts\AgentServiceInterface;

class AgentService implements AgentServiceInterface
{
    /**
     * æ³¨å†Œæ–°Agent
     */
    public function register(array $data): Agent;

    /**
     * è·å–Agentä¿¡æ¯
     */
    public function getAgent(string $agentId): ?Agent;

    /**
     * æ›´æ–°AgentçŠ¶æ€
     */
    public function updateStatus(string $agentId, string $status): bool;

    /**
     * æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
     */
    public function updateLastActive(string $agentId): bool;

    /**
     * è·å–åœ¨çº¿Agentåˆ—è¡¨
     */
    public function getOnlineAgents(): Collection;

    /**
     * æ’¤é”€Agent
     */
    public function revoke(string $agentId, string $reason = ''): bool;

    /**
     * ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
     */
    public function generateAccessToken(string $agentId): string;

    /**
     * éªŒè¯è®¿é—®ä»¤ç‰Œ
     */
    public function validateToken(string $token): ?Agent;
}
```

### 2. AuthenticationService

```php
<?php

namespace App\Modules\Agent\Services;

class AuthenticationService
{
    /**
     * è®¤è¯Agent
     */
    public function authenticate(string $token, string $agentId = null): Agent;

    /**
     * éªŒè¯ä»¤ç‰Œ
     */
    public function validateToken(string $token): bool;

    /**
     * åˆ·æ–°ä»¤ç‰Œ
     */
    public function refreshToken(string $agentId): string;

    /**
     * æ’¤é”€ä»¤ç‰Œ
     */
    public function revokeToken(string $token): bool;

    /**
     * æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
     */
    public function isTokenExpired(string $token): bool;

    /**
     * è·å–ä»¤ç‰Œä¿¡æ¯
     */
    public function getTokenInfo(string $token): array;
}
```

### 3. AuthorizationService

```php
<?php

namespace App\Modules\Agent\Services;

class AuthorizationService
{
    /**
     * æ£€æŸ¥é¡¹ç›®è®¿é—®æƒé™
     */
    public function canAccessProject(Agent $agent, int $projectId): bool;

    /**
     * æ£€æŸ¥æ“ä½œæƒé™
     */
    public function canPerformAction(Agent $agent, string $action): bool;

    /**
     * æ£€æŸ¥èµ„æºè®¿é—®æƒé™
     */
    public function canAccessResource(Agent $agent, string $resource): bool;

    /**
     * è·å–Agentæƒé™åˆ—è¡¨
     */
    public function getPermissions(Agent $agent): array;

    /**
     * æˆäºˆæƒé™
     */
    public function grantPermission(Agent $agent, string $permission, array $scope = []): bool;

    /**
     * æ’¤é”€æƒé™
     */
    public function revokePermission(Agent $agent, string $permission): bool;

    /**
     * æ£€æŸ¥æƒé™èŒƒå›´
     */
    public function checkScope(Agent $agent, string $permission, array $context): bool;
}
```

### 4. PermissionService

```php
<?php

namespace App\Modules\Agent\Services;

class PermissionService
{
    /**
     * å®šä¹‰æƒé™å¸¸é‡
     */
    public const PERMISSIONS = [
        'read' => 'Read access to resources',
        'create_task' => 'Create new tasks',
        'update_task' => 'Update existing tasks',
        'delete_task' => 'Delete tasks',
        'claim_task' => 'Claim tasks for execution',
        'complete_task' => 'Mark tasks as completed',
        'manage_project' => 'Manage project settings',
        'sync_github' => 'Sync with GitHub repositories',
        'create_github_issue' => 'Create GitHub issues',
        'update_github_issue' => 'Update GitHub issues',
        'admin' => 'Administrative access',
    ];

    /**
     * è·å–æ‰€æœ‰å¯ç”¨æƒé™
     */
    public function getAvailablePermissions(): array;

    /**
     * éªŒè¯æƒé™åç§°
     */
    public function isValidPermission(string $permission): bool;

    /**
     * è·å–æƒé™å±‚æ¬¡ç»“æ„
     */
    public function getPermissionHierarchy(): array;

    /**
     * æ£€æŸ¥æƒé™ä¾èµ–
     */
    public function checkPermissionDependencies(array $permissions): array;

    /**
     * è®¡ç®—æœ‰æ•ˆæƒé™
     */
    public function calculateEffectivePermissions(Agent $agent): array;
}
```

## Agentæ¨¡å‹æ‰©å±•

### Agentæƒé™æ¨¡å‹

```php
<?php

namespace App\Modules\Agent\Models;

class AgentPermission extends Model
{
    protected $fillable = [
        'agent_id',
        'permission',
        'scope',
        'granted_by',
        'granted_at',
        'expires_at',
    ];

    protected $casts = [
        'scope' => 'array',
        'granted_at' => 'datetime',
        'expires_at' => 'datetime',
    ];

    /**
     * æ£€æŸ¥æƒé™æ˜¯å¦è¿‡æœŸ
     */
    public function isExpired(): bool
    {
        return $this->expires_at && $this->expires_at->isPast();
    }

    /**
     * æ£€æŸ¥æƒé™èŒƒå›´
     */
    public function matchesScope(array $context): bool
    {
        if (empty($this->scope)) {
            return true; // æ— é™åˆ¶
        }

        foreach ($this->scope as $key => $value) {
            if (!isset($context[$key]) || $context[$key] !== $value) {
                return false;
            }
        }

        return true;
    }
}
```

### Agentä¼šè¯æ¨¡å‹

```php
<?php

namespace App\Modules\Agent\Models;

class AgentSession extends Model
{
    protected $fillable = [
        'agent_id',
        'session_id',
        'ip_address',
        'user_agent',
        'started_at',
        'last_activity',
        'expires_at',
        'is_active',
    ];

    protected $casts = [
        'started_at' => 'datetime',
        'last_activity' => 'datetime',
        'expires_at' => 'datetime',
        'is_active' => 'boolean',
    ];

    /**
     * æ›´æ–°ä¼šè¯æ´»åŠ¨æ—¶é—´
     */
    public function updateActivity(): void
    {
        $this->update(['last_activity' => now()]);
    }

    /**
     * æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ
     */
    public function isExpired(): bool
    {
        return $this->expires_at && $this->expires_at->isPast();
    }

    /**
     * ç»ˆæ­¢ä¼šè¯
     */
    public function terminate(): void
    {
        $this->update(['is_active' => false]);
    }
}
```

## æƒé™ç­–ç•¥

### Agentè®¿é—®ç­–ç•¥

```php
<?php

namespace App\Modules\Agent\Policies;

class AgentPolicy
{
    /**
     * æ£€æŸ¥æ˜¯å¦å¯ä»¥æŸ¥çœ‹Agent
     */
    public function view(User $user, Agent $agent): bool
    {
        return $user->id === $agent->user_id || $user->hasRole('admin');
    }

    /**
     * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ›´æ–°Agent
     */
    public function update(User $user, Agent $agent): bool
    {
        return $user->id === $agent->user_id || $user->hasRole('admin');
    }

    /**
     * æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ é™¤Agent
     */
    public function delete(User $user, Agent $agent): bool
    {
        return $user->id === $agent->user_id || $user->hasRole('admin');
    }

    /**
     * æ£€æŸ¥æ˜¯å¦å¯ä»¥ç®¡ç†Agentæƒé™
     */
    public function managePermissions(User $user, Agent $agent): bool
    {
        return $user->hasRole('admin') ||
               ($user->id === $agent->user_id && $user->hasPermission('manage_agent_permissions'));
    }
}
```

### é¡¹ç›®è®¿é—®ç­–ç•¥

```php
<?php

namespace App\Modules\Agent\Policies;

class ProjectAccessPolicy
{
    /**
     * æ£€æŸ¥Agentæ˜¯å¦å¯ä»¥è®¿é—®é¡¹ç›®
     */
    public function canAccess(Agent $agent, Project $project): bool
    {
        // æ£€æŸ¥Agentæ˜¯å¦æœ‰é¡¹ç›®è®¿é—®æƒé™
        if (!in_array($project->id, $agent->allowed_projects ?? [])) {
            return false;
        }

        // æ£€æŸ¥é¡¹ç›®çŠ¶æ€
        if ($project->status !== 'active') {
            return false;
        }

        // æ£€æŸ¥AgentçŠ¶æ€
        if ($agent->status !== 'active') {
            return false;
        }

        return true;
    }

    /**
     * æ£€æŸ¥Agentæ˜¯å¦å¯ä»¥æ‰§è¡Œé¡¹ç›®æ“ä½œ
     */
    public function canPerformAction(Agent $agent, Project $project, string $action): bool
    {
        if (!$this->canAccess($agent, $project)) {
            return false;
        }

        return in_array($action, $agent->allowed_actions ?? []);
    }
}
```

## å‘½ä»¤è¡Œå·¥å…·

### æ³¨å†ŒAgentå‘½ä»¤

```php
<?php

namespace App\Modules\Agent\Commands;

class RegisterAgentCommand extends Command
{
    protected $signature = 'agent:register
                            {--name= : Agent name}
                            {--type= : Agent type}
                            {--user-id= : User ID}
                            {--projects= : Allowed project IDs}
                            {--permissions= : Allowed permissions}
                            {--expires-in= : Token expiration time in seconds}';

    protected $description = 'Register a new Agent';

    public function handle(AgentService $agentService): int
    {
        $data = [
            'name' => $this->option('name') ?: $this->ask('Agent name'),
            'type' => $this->option('type') ?: $this->ask('Agent type'),
            'user_id' => $this->option('user-id') ?: $this->ask('User ID'),
            'allowed_projects' => $this->parseProjects($this->option('projects')),
            'allowed_actions' => $this->parsePermissions($this->option('permissions')),
            'token_expires_in' => $this->option('expires-in') ?: 86400,
        ];

        try {
            $agent = $agentService->register($data);
            $token = $agentService->generateAccessToken($agent->agent_id);

            $this->info("Agent registered successfully!");
            $this->table(['Field', 'Value'], [
                ['Agent ID', $agent->agent_id],
                ['Name', $agent->name],
                ['Type', $agent->type],
                ['Access Token', $token],
                ['Allowed Projects', implode(', ', $agent->allowed_projects ?? [])],
                ['Permissions', implode(', ', $agent->allowed_actions ?? [])],
            ]);

            return 0;
        } catch (\Exception $e) {
            $this->error("Failed to register agent: " . $e->getMessage());
            return 1;
        }
    }
}
```

## äº‹ä»¶å’Œç›‘å¬å™¨

### Agentäº‹ä»¶

```php
<?php

namespace App\Modules\Agent\Events;

class AgentRegistered
{
    public function __construct(
        public readonly Agent $agent,
        public readonly User $registeredBy,
        public readonly \DateTime $timestamp
    ) {}
}

class AgentAuthenticated
{
    public function __construct(
        public readonly Agent $agent,
        public readonly string $ipAddress,
        public readonly string $userAgent,
        public readonly \DateTime $timestamp
    ) {}
}

class PermissionGranted
{
    public function __construct(
        public readonly Agent $agent,
        public readonly string $permission,
        public readonly array $scope,
        public readonly User $grantedBy,
        public readonly \DateTime $timestamp
    ) {}
}
```

### äº‹ä»¶ç›‘å¬å™¨

```php
<?php

namespace App\Modules\Agent\Listeners;

class LogAgentActivity
{
    public function handle(AgentAuthenticated $event): void
    {
        AgentAuditLog::create([
            'agent_id' => $event->agent->agent_id,
            'action' => 'authenticated',
            'ip_address' => $event->ipAddress,
            'user_agent' => $event->userAgent,
            'timestamp' => $event->timestamp,
        ]);
    }
}

class UpdateAgentStatus
{
    public function handle(AgentAuthenticated $event): void
    {
        $event->agent->updateLastActive();
    }
}
```

## ä¸­é—´ä»¶

### Agentè®¤è¯ä¸­é—´ä»¶

```php
<?php

namespace App\Modules\Agent\Middleware;

class AgentAuthMiddleware
{
    public function handle(Request $request, \Closure $next)
    {
        $token = $request->bearerToken() ?: $request->query('token');
        $agentId = $request->header('Agent-ID') ?: $request->query('agent_id');

        if (!$token) {
            throw new AuthenticationException('Access token required');
        }

        $authService = app(AuthenticationService::class);

        try {
            $agent = $authService->authenticate($token, $agentId);
            $request->setAgent($agent);

            // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
            $agent->updateLastActive();

            return $next($request);
        } catch (\Exception $e) {
            throw new AuthenticationException('Invalid access token');
        }
    }
}
```

## é…ç½®ç®¡ç†

```php
// config/agent.php
return [
    'token' => [
        'default_expiry' => env('AGENT_TOKEN_EXPIRY', 86400),
        'refresh_threshold' => env('AGENT_TOKEN_REFRESH_THRESHOLD', 3600),
        'max_tokens_per_agent' => env('AGENT_MAX_TOKENS', 5),
    ],

    'session' => [
        'timeout' => env('AGENT_SESSION_TIMEOUT', 1800),
        'max_sessions_per_agent' => env('AGENT_MAX_SESSIONS', 3),
        'cleanup_interval' => env('AGENT_SESSION_CLEANUP', 300),
    ],

    'permissions' => [
        'default' => ['read'],
        'admin_required' => ['admin', 'manage_project'],
        'inheritance_enabled' => env('AGENT_PERMISSION_INHERITANCE', true),
    ],

    'rate_limiting' => [
        'enabled' => env('AGENT_RATE_LIMITING', true),
        'requests_per_minute' => env('AGENT_RATE_LIMIT', 60),
        'burst_limit' => env('AGENT_BURST_LIMIT', 10),
    ],
];
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- [MCPåè®®æ¨¡å—](./mcp.md)
- [é¡¹ç›®æ¨¡å—](./project.md)
- [ä»»åŠ¡æ¨¡å—](./task.md)
