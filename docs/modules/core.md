# Core 核心模块

## 概述

Core模块是MCP Tools的基础设施层，提供所有其他模块依赖的核心服务和公共组件。它负责系统的基础功能，包括配置管理、日志记录、缓存服务、事件系统等。

## 职责范围

### 1. 配置管理
- 统一的配置加载和管理
- 环境变量处理
- 配置验证和默认值
- 动态配置更新

### 2. 日志服务
- 结构化日志记录
- 多渠道日志输出
- 日志级别控制
- 性能日志和审计日志

### 3. 缓存服务
- 多层缓存策略
- 缓存键管理
- 缓存失效机制
- 分布式缓存支持

### 4. 事件系统
- 事件定义和分发
- 异步事件处理
- 事件监听器管理
- 事件重试机制

### 5. 异常处理
- 统一异常处理
- 错误码定义
- 异常日志记录
- 用户友好的错误信息

## 目录结构

```
app/Modules/Core/
├── Services/
│   ├── ConfigService.php          # 配置服务
│   ├── CacheService.php           # 缓存服务
│   ├── LogService.php             # 日志服务
│   └── EventService.php           # 事件服务
├── Contracts/
│   ├── ConfigInterface.php        # 配置接口
│   ├── CacheInterface.php         # 缓存接口
│   ├── LogInterface.php           # 日志接口
│   └── EventInterface.php         # 事件接口
├── Events/
│   ├── SystemStarted.php          # 系统启动事件
│   ├── ConfigUpdated.php          # 配置更新事件
│   └── CacheCleared.php           # 缓存清理事件
├── Exceptions/
│   ├── CoreException.php          # 核心异常基类
│   ├── ConfigException.php        # 配置异常
│   └── CacheException.php         # 缓存异常
├── Providers/
│   ├── CoreServiceProvider.php    # 核心服务提供者
│   └── EventServiceProvider.php   # 事件服务提供者
├── Middleware/
│   ├── LogRequestMiddleware.php   # 请求日志中间件
│   └── CacheMiddleware.php        # 缓存中间件
└── Helpers/
    ├── ArrayHelper.php            # 数组工具
    ├── StringHelper.php           # 字符串工具
    └── DateHelper.php             # 日期工具
```

## 核心服务

### 1. ConfigService - 配置管理服务

**主要功能**：
- 统一配置管理接口
- 支持多层级配置结构
- 配置缓存和热更新
- 环境变量集成
- 配置验证和类型转换

**服务接口**：
- 配置值的获取和设置
- 配置存在性检查
- 批量配置操作
- 配置缓存管理
- 环境配置读取

### 2. CacheService - 缓存管理服务

**主要功能**：
- 多层缓存策略支持
- 缓存键命名空间管理
- TTL（生存时间）控制
- 缓存标签和分组
- 分布式缓存支持

**服务接口**：
- 缓存数据的存取操作
- 缓存失效和清理
- 缓存键生成和管理
- 缓存统计和监控
- 缓存预热机制

### 3. LogService - 日志管理服务

**主要功能**：
- 结构化日志记录
- 多渠道日志输出
- 日志级别控制
- 性能和审计日志
- 日志轮转和归档

**服务接口**：
- 不同级别的日志记录
- 上下文信息记录
- 性能指标日志
- 审计操作日志
- 日志查询和分析

### 4. EventService - 事件管理服务

**主要功能**：
- 事件的定义和分发
- 异步事件处理
- 事件监听器管理
- 事件重试机制
- 事件序列化存储

**服务接口**：
- 事件分发和监听
- 事件订阅管理
- 异步事件处理
- 批量事件操作
- 事件状态跟踪

## 配置管理

### 配置文件结构

**核心配置项**：
- **缓存配置**：默认TTL、缓存前缀、标签支持
- **日志配置**：日志渠道、日志级别、输出格式
- **事件配置**：异步处理、重试机制、延迟设置
- **性能配置**：内存限制、超时设置、并发控制

**环境变量支持**：
- 支持通过环境变量覆盖默认配置
- 提供配置验证和类型转换
- 支持配置热更新和缓存

## 事件定义

### 系统事件

**SystemStarted - 系统启动事件**：
- 系统版本信息
- 加载的模块列表
- 启动时间戳
- 系统配置摘要

**ConfigUpdated - 配置更新事件**：
- 配置键名
- 旧值和新值
- 更新操作者
- 更新时间戳

**CacheCleared - 缓存清理事件**：
- 清理模式（全部/模式匹配）
- 清理的缓存数量
- 清理原因
- 执行时间

## 异常处理

### 异常层次结构

**CoreException - 核心异常基类**：
- 提供统一的错误码机制
- 支持上下文信息记录
- 集成日志记录功能
- 支持异常链追踪

**ConfigException - 配置异常**：
- 配置文件解析错误
- 配置验证失败
- 配置访问权限问题

**CacheException - 缓存异常**：
- 缓存连接失败
- 缓存操作超时
- 缓存数据损坏

## 中间件

### 请求日志中间件

**功能特性**：
- 记录请求开始和结束时间
- 捕获请求基本信息（方法、URL、IP等）
- 计算请求处理时间
- 记录响应状态和内存使用
- 支持性能分析和监控

**应用场景**：
- API请求监控
- 性能瓶颈分析
- 用户行为追踪
- 系统负载监控

## 工具类

### 数组工具类

**主要功能**：
- 深度数组合并
- 嵌套值的获取和设置
- 数组扁平化处理
- 数组结构验证
- 数组转换和格式化

**使用场景**：
- 配置数据处理
- API响应格式化
- 数据结构转换
- 嵌套数据操作

## 性能优化

### 1. 缓存策略
- L1缓存：内存缓存（APCu）
- L2缓存：Redis缓存
- L3缓存：数据库缓存

### 2. 事件优化
- 异步事件处理
- 事件批量处理
- 事件去重机制

### 3. 日志优化
- 日志缓冲写入
- 日志压缩存储
- 日志分级处理

## 监控指标

### 1. 性能指标
- 请求响应时间
- 内存使用情况
- 缓存命中率

### 2. 业务指标
- 事件处理数量
- 配置更新频率
- 异常发生率

### 3. 系统指标
- CPU使用率
- 磁盘I/O
- 网络延迟

---

**相关文档**：
- [MCP协议模块](./mcp.md)
- [Agent代理模块](./agent.md)
- [配置参考](../configuration.md)
