# MCP Tools 模块化架构文档

## 概述

MCP Tools 采用模块化架构设计，将功能按照业务领域划分为独立的模块，每个模块负责特定的功能域，具有清晰的边界和接口。

## 技术栈

### 核心框架
- **Laravel 11**：主框架
- **SQLite**：数据库（开发阶段）

### 核心包依赖
- **php-mcp/laravel**：MCP协议Laravel集成包，提供原生MCP支持
- **dcat/laravel-admin**：后台管理界面，快速构建管理系统
- **inhere/php-validate**：数据验证库，提供强大的验证功能
- **spatie/laravel-route-attributes**：路由属性注解，简化路由定义

### 架构模式
- **模块化架构**：按业务领域划分模块
- **事件驱动**：模块间通过事件通信
- **依赖注入**：使用Laravel容器管理依赖
- **接口抽象**：通过接口定义模块边界
- **包集成架构**：深度集成第三方包提供核心功能

## 架构原则

### 1. 单一职责原则
每个模块只负责一个特定的业务领域，避免功能耦合。

### 2. 依赖倒置原则
模块间通过接口进行交互，高层模块不依赖低层模块的具体实现。

### 3. 开闭原则
模块对扩展开放，对修改关闭，通过插件机制支持功能扩展。

### 4. 接口隔离原则
每个模块只暴露必要的接口，隐藏内部实现细节。

## 核心模块

### 1. [Core 核心模块](./核心模块.md)
- **职责**：提供基础服务和公共组件
- **包含**：配置管理、日志记录、缓存服务、事件系统
- **位置**：`app/Modules/Core/`

### 2. [User 用户模块](./用户模块.md)
- **职责**：用户账户和身份管理
- **包含**：用户注册、认证、资料管理、角色权限
- **位置**：`app/Modules/User/`

### 3. [MCP 协议模块](./MCP协议模块.md)
- **职责**：实现MCP协议的核心功能（专注于任务处理）
- **包含**：协议解析、SSE服务、连接管理、消息路由、任务相关Resources和Tools
- **位置**：`app/Modules/Mcp/`
- **边界**：不处理用户管理，只提供任务和资源访问接口

### 4. [Agent 代理模块](./Agent代理模块.md)
- **职责**：管理AI Agent的生命周期和权限（与User模块协作）
- **包含**：Agent注册、认证、权限控制、状态管理
- **位置**：`app/Modules/Agent/`
- **边界**：专注于AI Agent管理，不处理人类用户管理

### 5. [Project 项目模块](./项目模块.md)
- **职责**：项目管理和配置
- **包含**：项目CRUD、成员管理、设置配置、统计分析
- **位置**：`app/Modules/Project/`

### 6. [Task 任务模块](./任务模块.md)
- **职责**：任务管理
- **包含**：任务CRUD、状态流转、分配机制、优先级管理
- **位置**：`app/Modules/Task/`

### 7. [Notification 通知模块](./通知模块.md)
- **职责**：实时通知和消息推送
- **包含**：SSE推送、事件监听、消息队列、通知模板
- **位置**：`app/Modules/Notification/`

### 8. [SuperAdmin 超级管理员模块](./超级管理员模块.md)
- **职责**：系统级后台管理界面
- **包含**：全局用户管理、系统配置、监控面板、数据统计、Agent审核
- **位置**：`app/Modules/SuperAdmin/`
- **访问路径**：`/super-admin`

### 9. [UserAdmin 用户后台模块](./用户后台模块.md)
- **职责**：用户级后台管理界面
- **包含**：个人项目管理、任务管理、Agent管理
- **位置**：`app/Modules/UserAdmin/`
- **访问路径**：`/user-admin`

## 后期扩展模块

### [GitHub 集成模块](./GitHub集成模块.md) 🔮
- **职责**：GitHub平台集成 (可选扩展)
- **包含**：API集成、Issues同步、Webhook处理、仓库管理
- **位置**：`app/Modules/GitHub/`
- **说明**：作为后期扩展功能，不是核心开发阶段的必需品

## 模块间通信

### 1. 事件驱动
模块间通过Laravel事件系统进行松耦合通信。

### 2. 服务容器
通过依赖注入容器管理模块间的依赖关系。

### 3. 消息队列
异步任务通过队列系统处理，避免阻塞主流程。

### 4. 数据库事务
跨模块操作通过数据库事务保证数据一致性。

## 目录结构

```
app/Modules/
├── Core/                   # 核心模块
│   ├── Services/          # 核心服务
│   ├── Contracts/         # 接口定义
│   ├── Events/            # 核心事件
│   └── Providers/         # 服务提供者
├── User/                  # 用户模块
│   ├── Models/            # 用户模型
│   ├── Services/          # 用户服务
│   ├── Controllers/       # 用户控制器
│   ├── Policies/          # 访问策略
│   └── Notifications/     # 用户通知
├── Mcp/                   # MCP协议模块
│   ├── Server/            # MCP服务器
│   ├── Resources/         # MCP资源
│   ├── Tools/             # MCP工具
│   ├── Transports/        # 传输层
│   └── Middleware/        # 中间件
├── Agent/                 # Agent模块
│   ├── Models/            # Agent模型
│   ├── Services/          # Agent服务
│   ├── Commands/          # 命令行工具
│   └── Policies/          # 权限策略
├── Project/               # 项目模块
│   ├── Models/            # 项目模型
│   ├── Services/          # 项目服务
│   ├── Controllers/       # 控制器
│   └── Resources/         # API资源
├── Task/                  # 任务模块
│   ├── Models/            # 任务模型
│   ├── Services/          # 任务服务
│   ├── Workflows/         # 工作流
│   └── Observers/         # 模型观察者
├── GitHub/                # GitHub模块 (后期扩展)
│   ├── Services/          # GitHub服务
│   ├── Webhooks/          # Webhook处理
│   ├── Sync/              # 同步服务
│   └── Api/               # API客户端
├── Notification/          # 通知模块
│   ├── Channels/          # 通知渠道
│   ├── Events/            # 通知事件
│   ├── Listeners/         # 事件监听器
│   └── Templates/         # 通知模板
└── Admin/                 # 管理模块
    ├── Controllers/       # 管理控制器
    ├── Resources/         # 管理资源
    ├── Widgets/           # 仪表板组件
    └── Middleware/        # 管理中间件
```

## 开发规范

### 1. 命名规范
- 模块名使用PascalCase：`ProjectModule`
- 服务类使用Service后缀：`ProjectService`
- 控制器使用Controller后缀：`ProjectController`

### 2. 接口定义
每个模块必须定义清晰的接口契约，放在`Contracts`目录下。

### 3. 测试覆盖
每个模块必须包含完整的单元测试和集成测试。

### 4. 文档维护
每个模块必须维护详细的API文档和使用说明。

## 扩展机制

### 1. 插件系统
支持通过插件扩展模块功能，插件遵循统一的接口规范。

### 2. 钩子机制
在关键节点提供钩子，允许外部代码介入处理流程。

### 3. 配置驱动
通过配置文件控制模块行为，支持运行时动态调整。

## 部署策略

### 1. 模块独立部署
支持按模块进行独立部署和版本管理。

### 2. 服务发现
通过服务注册中心实现模块间的服务发现。

### 3. 负载均衡
支持模块级别的负载均衡和故障转移。

## 监控和运维

### 1. 模块监控
每个模块提供健康检查接口和性能指标。

### 2. 日志聚合
统一的日志格式和聚合机制，便于问题排查。

### 3. 链路追踪
支持分布式链路追踪，监控跨模块调用。

---

**下一步**：查看具体模块的详细设计文档。
